<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summary Daily Delivery Order</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome untuk icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js untuk visualisasi data -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS untuk membaca file Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --info-color: #7209b7;
            --sidebar-bg: #2c3e50;
            --filter-bg: #ecf0f1;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2c3e50;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 15px 0;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .sidebar {
            background: var(--sidebar-bg);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            height: fit-content;
            margin-bottom: 20px;
        }
        .filter-section {
            background-color: var(--filter-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .kpi-card {
            background: linear-gradient(135deg, #ffffff 0%, #f1f8ff 100%);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            height: 100%;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px rgba(0,0,0,0.15);
        }
        .kpi-value {
            font-size: 26px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        .kpi-label {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }
        .chart-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            transition: transform 0.3s ease;
            height: 350px;
        }
        .chart-container:hover {
            transform: translateY(-3px);
        }
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--secondary-color);
            text-align: center;
        }
        .nav-tabs .nav-link {
            color: var(--dark-color);
            font-weight: 500;
            border: none;
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
        }
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            font-weight: 600;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-bottom: 3px solid var(--primary-color);
        }
        .footer {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 15px 0;
            text-align: center;
            margin-top: 30px;
            border-radius: 10px 10px 0 0;
        }
        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.7);
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            color: white;
        }
        .upload-area:hover {
            background-color: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.9);
        }
        .icon-box {
            display: inline-flex;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            border-radius: 50%;
            text-align: center;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(67, 97, 238, 0.3);
            color: white;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: white;
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(108, 117, 125, 0.3);
            color: white;
        }
        .form-control, .form-select {
            border-radius: 6px;
            border: 1px solid #ced4da;
            padding: 8px 12px;
            transition: all 0.3s ease;
            color: #2c3e50;
        }
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
            border-color: var(--primary-color);
        }
        .select-all-btn {
            margin-bottom: 8px;
            font-size: 12px;
            padding: 3px 8px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .select-all-btn:hover {
            background-color: #2980b9;
        }
        .filter-toggle {
            cursor: pointer;
            color: #3498db;
            margin-bottom: 10px;
            display: inline-block;
            font-weight: 600;
        }
        .main-content {
            padding-left: 10px;
        }
        @media (max-width: 992px) {
            .main-content {
                padding-left: 0;
            }
            .chart-container {
                height: 300px;
            }
        }
        .filter-row {
            margin-bottom: 15px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }
        label {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1 class="text-center"><i class="fas fa-chart-line me-2"></i>Summary Daily Delivery Order</h1>
            <p class="text-center mb-0" id="last-update">Last Update: -</p>
        </div>
    </div>

    <div class="container">
        <!-- Upload Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="upload-area">
                    <h4><i class="fas fa-file-excel me-2"></i>Upload File Excel</h4>
                    <p>File harus berformat Excel (.xlsx) dengan ukuran 2MB - 30MB</p>
                    <input type="file" id="file-upload" class="form-control" accept=".xlsx, .xls">
                    <div class="mt-2">
                        <small class="form-text">
                            Pastikan file Excel memiliki kolom: Area, DP Date, DP No, Plant Name, QTY, Truck No, Sales Man, Distance, End Customer Name
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Filter Section -->
            <div class="col-lg-12">
                <div class="filter-section">
                    <h5 class="filter-toggle" data-bs-toggle="collapse" href="#filterCollapse">
                        <i class="fas fa-filter"></i> Filter Data <i class="fas fa-chevron-down"></i>
                    </h5>
                    <div class="collapse show" id="filterCollapse">
                        <div class="row filter-row">
                            <div class="col-md-3 mb-2">
                                <button class="select-all-btn" data-target="area-filter">Select All Areas</button>
                                <label for="area-filter" class="form-label">Area</label>
                                <select class="form-select" id="area-filter" multiple>
                                    <!-- Options akan diisi oleh JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="start-date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="start-date">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="end-date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="end-date">
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="select-all-btn" data-target="plant-filter">Select All Plants</button>
                                <label for="plant-filter" class="form-label">Plant Name</label>
                                <select class="form-select" id="plant-filter" multiple>
                                    <!-- Options akan diisi oleh JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="select-all-btn" data-target="salesman-filter">Select All Salesmen</button>
                                <label for="salesman-filter" class="form-label">Sales Man</label>
                                <select class="form-select" id="salesman-filter" multiple>
                                    <!-- Options akan diisi oleh JavaScript -->
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <button class="select-all-btn" data-target="customer-filter">Select All Customers</button>
                                <label for="customer-filter" class="form-label">End Customer Name</label>
                                <select class="form-select" id="customer-filter" multiple>
                                    <!-- Options akan diisi oleh JavaScript -->
                                </select>
                            </div>
                            <div class="col-12 mt-2">
                                <button class="btn btn-primary" id="apply-filters">Terapkan Filter</button>
                                <button class="btn btn-secondary" id="reset-filters">Reset Filter</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI Section -->
        <div class="row mb-4">
            <div class="col-md-2 col-sm-6">
                <div class="kpi-card">
                    <div class="kpi-value" id="total-area">0</div>
                    <div class="kpi-label">Total Area</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-6">
                <div class="kpi-card">
                    <div class="kpi-value" id="total-plant">0</div>
                    <div class="kpi-label">Total Plant</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-6">
                <div class="kpi-card">
                    <div class="kpi-value" id="total-volume">0</div>
                    <div class="kpi-label">Total Volume</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-6">
                <div class="kpi-card">
                    <div class="kpi-value" id="avg-trip-tm">0</div>
                    <div class="kpi-label">Avg Trip/TM</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-6">
                <div class="kpi-card">
                    <div class="kpi-value" id="total-tm">0</div>
                    <div class="kpi-label">Total TM</div>
                </div>
            </div>
            <div class="col-md-2 col-sm-6">
                <div class="kpi-card">
                    <div class="kpi-value" id="avg-load-trip">0</div>
                    <div class="kpi-label">Avg Load/Trip</div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="logistic-tab" data-bs-toggle="tab" data-bs-target="#logistic" type="button" role="tab" aria-controls="logistic" aria-selected="true">
                    <i class="fas fa-truck"></i> Logistic
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales" type="button" role="tab" aria-controls="sales" aria-selected="false">
                    <i class="fas fa-chart-line"></i> Sales And End Customer Performance
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="dashboardTabContent">
            <!-- Logistic Tab -->
            <div class="tab-pane fade show active" id="logistic" role="tabpanel" aria-labelledby="logistic-tab">
                <div class="row mb-4">
                    <div class="col-12">
                        <h4 class="section-title"><span class="icon-box"><i class="fas fa-chart-bar"></i></span> Delivery Performance</h4>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">Total Volume Delivery Per Area</div>
                            <canvas id="volume-per-area-chart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">Volume Per Day/Area</div>
                            <canvas id="volume-per-day-area-chart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">Volume Per Day/Plant</div>
                            <canvas id="volume-per-day-plant-chart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">Total Volume Delivery Per Plant Name</div>
                            <canvas id="volume-per-plant-chart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">Avg Volume Delivery /Day per Area</div>
                            <canvas id="avg-volume-day-area-chart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">Avg Volume Delivery /Day Per Plant</div>
                            <canvas id="avg-volume-day-plant-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4 mt-4">
                    <div class="col-12">
                        <h4 class="section-title"><span class="icon-box"><i class="fas fa-truck-loading"></i></span> Truck Utilization</h4>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">Total Volume Delivery Per Truck No</div>
                            <canvas id="volume-per-truck-chart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">Total Trip per Truck No</div>
                            <canvas id="trip-per-truck-chart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">Avg Load per Trip per Truck No</div>
                            <canvas id="avg-load-truck-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4 mt-4">
                    <div class="col-12">
                        <h4 class="section-title"><span class="icon-box"><i class="fas fa-route"></i></span> Distance</h4>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">Avg Distance Per Area</div>
                            <canvas id="avg-distance-area-chart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">Avg Distance Per Plant Name</div>
                            <canvas id="avg-distance-plant-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Tab -->
            <div class="tab-pane fade" id="sales" role="tabpanel" aria-labelledby="sales-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">Total Volume Per Sales Man</div>
                            <canvas id="volume-salesman-chart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <div class="chart-title">Total Volume Per End Customer Name</div>
                            <canvas id="volume-customer-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="container">
            <p>Summary Daily Delivery Order by L=23-51Xe</p>
        </div>
    </div>

    <!-- Bootstrap & jQuery JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Data global untuk menyimpan data Excel
        let rawData = [];
        let filteredData = [];
        
        // Chart objects
        let charts = {};
        
        // Fungsi normalisasi string
        function normalizeString(str) {
            if (typeof str !== 'string') return '';
            return str.toLowerCase().replace(/\s+/g, ' ').trim();
        }
        
        // Fungsi untuk mendapatkan nilai unik dengan normalisasi
        function getNormalizedUniqueValues(data, key) {
            const normalizedMap = new Map();
            
            data.forEach(item => {
                const value = item[key];
                if (value !== undefined && value !== null && value !== '') {
                    const normalized = normalizeString(value);
                    if (!normalizedMap.has(normalized)) {
                        normalizedMap.set(normalized, value);
                    }
                }
            });
            
            return Array.from(normalizedMap.values());
        }
        
        // Fungsi untuk membandingkan nilai dengan normalisasi
        function compareNormalized(value1, value2) {
            return normalizeString(value1) === normalizeString(value2);
        }
        
        // Update last update time
        function updateLastUpdateTime() {
            const now = new Date();
            const formattedDate = now.toLocaleString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('last-update').textContent = `Last Update: ${formattedDate}`;
        }
        
        // Inisialisasi
        document.addEventListener('DOMContentLoaded', function() {
            updateLastUpdateTime();
            
            // Event listener untuk upload file
            document.getElementById('file-upload').addEventListener('change', handleFileUpload);
            
            // Event listener untuk filter
            document.getElementById('apply-filters').addEventListener('click', applyFilters);
            document.getElementById('reset-filters').addEventListener('click', resetFilters);
            
            // Event listener untuk area filter change (untuk update plant filter)
            document.getElementById('area-filter').addEventListener('change', updatePlantFilterOptions);
            
            // Event listener untuk select all buttons
            document.querySelectorAll('.select-all-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const selectElement = document.getElementById(targetId);
                    Array.from(selectElement.options).forEach(option => {
                        option.selected = true;
                    });
                });
            });
        });
        
        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validasi ukuran file
            const fileSizeMB = file.size / (1024 * 1024);
            if (fileSizeMB < 2 || fileSizeMB > 30) {
                alert('Ukuran file harus antara 2MB dan 30MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Ambil data dari sheet pertama
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                // Simpan data mentah
                rawData = jsonData;
                filteredData = [...rawData];
                
                // Update filter options
                updateFilterOptions();
                
                // Proses data dan update dashboard
                processData();
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Update opsi filter
        function updateFilterOptions() {
            // Area filter
            const areas = getNormalizedUniqueValues(rawData, 'Area');
            const areaFilter = document.getElementById('area-filter');
            areaFilter.innerHTML = '';
            areas.forEach(area => {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                areaFilter.appendChild(option);
            });
            
            // Plant filter
            updatePlantFilterOptions();
            
            // Salesman filter
            const salesmen = getNormalizedUniqueValues(rawData, 'Sales Man');
            const salesmanFilter = document.getElementById('salesman-filter');
            salesmanFilter.innerHTML = '';
            salesmen.forEach(salesman => {
                const option = document.createElement('option');
                option.value = salesman;
                option.textContent = salesman;
                salesmanFilter.appendChild(option);
            });
            
            // Customer filter
            const customers = getNormalizedUniqueValues(rawData, 'End Customer Name');
            const customerFilter = document.getElementById('customer-filter');
            customerFilter.innerHTML = '';
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer;
                option.textContent = customer;
                customerFilter.appendChild(option);
            });
            
            // Set date range
            const dates = rawData.map(item => new Date(item['DP Date'])).filter(d => !isNaN(d));
            const minDate = new Date(Math.min.apply(null, dates));
            const maxDate = new Date(Math.max.apply(null, dates));
            
            document.getElementById('start-date').valueAsDate = minDate;
            document.getElementById('end-date').valueAsDate = maxDate;
        }
        
        // Update plant filter berdasarkan area yang dipilih
        function updatePlantFilterOptions() {
            const selectedAreas = Array.from(document.getElementById('area-filter').selectedOptions)
                .map(option => option.value);
            
            let plants;
            if (selectedAreas.length > 0) {
                plants = getNormalizedUniqueValues(
                    rawData.filter(item => 
                        selectedAreas.some(area => compareNormalized(area, item.Area))
                    ), 
                    'Plant Name'
                );
            } else {
                plants = getNormalizedUniqueValues(rawData, 'Plant Name');
            }
            
            const plantFilter = document.getElementById('plant-filter');
            plantFilter.innerHTML = '';
            plants.forEach(plant => {
                const option = document.createElement('option');
                option.value = plant;
                option.textContent = plant;
                plantFilter.appendChild(option);
            });
        }
        
        // Terapkan filter
        function applyFilters() {
            const selectedAreas = Array.from(document.getElementById('area-filter').selectedOptions)
                .map(option => option.value);
            const selectedPlants = Array.from(document.getElementById('plant-filter').selectedOptions)
                .map(option => option.value);
            const selectedSalesmen = Array.from(document.getElementById('salesman-filter').selectedOptions)
                .map(option => option.value);
            const selectedCustomers = Array.from(document.getElementById('customer-filter').selectedOptions)
                .map(option => option.value);
            
            const startDate = new Date(document.getElementById('start-date').value);
            const endDate = new Date(document.getElementById('end-date').value);
            endDate.setHours(23, 59, 59, 999); // Sampai akhir hari
            
            filteredData = rawData.filter(item => {
                // Filter area
                if (selectedAreas.length > 0 && !selectedAreas.some(area => compareNormalized(area, item.Area))) {
                    return false;
                }
                
                // Filter plant
                if (selectedPlants.length > 0 && !selectedPlants.some(plant => compareNormalized(plant, item['Plant Name']))) {
                    return false;
                }
                
                // Filter salesman
                if (selectedSalesmen.length > 0 && !selectedSalesmen.some(salesman => compareNormalized(salesman, item['Sales Man']))) {
                    return false;
                }
                
                // Filter customer
                if (selectedCustomers.length > 0 && !selectedCustomers.some(customer => compareNormalized(customer, item['End Customer Name']))) {
                    return false;
                }
                
                // Filter tanggal
                const itemDate = new Date(item['DP Date']);
                if (itemDate < startDate || itemDate > endDate) {
                    return false;
                }
                
                return true;
            });
            
            // Update dashboard dengan data yang sudah difilter
            processData();
        }
        
        // Reset filter
        function resetFilters() {
            document.getElementById('area-filter').selectedIndex = -1;
            document.getElementById('plant-filter').selectedIndex = -1;
            document.getElementById('salesman-filter').selectedIndex = -1;
            document.getElementById('customer-filter').selectedIndex = -1;
            
            const dates = rawData.map(item => new Date(item['DP Date'])).filter(d => !isNaN(d));
            const minDate = new Date(Math.min.apply(null, dates));
            const maxDate = new Date(Math.max.apply(null, dates));
            
            document.getElementById('start-date').valueAsDate = minDate;
            document.getElementById('end-date').valueAsDate = maxDate;
            
            filteredData = [...rawData];
            processData();
        }
        
        // Proses data dan update dashboard
        function processData() {
            updateLastUpdateTime();
            updateKPIs();
            updateCharts();
        }
        
        // Update KPI cards
        function updateKPIs() {
            // Total Area
            const totalArea = new Set(filteredData.map(item => normalizeString(item.Area))).size;
            document.getElementById('total-area').textContent = totalArea;
            
            // Total Plant
            const totalPlant = new Set(filteredData.map(item => normalizeString(item['Plant Name']))).size;
            document.getElementById('total-plant').textContent = totalPlant;
            
            // Total Volume
            const totalVolume = filteredData.reduce((sum, item) => sum + (Number(item.QTY) || 0), 0);
            document.getElementById('total-volume').textContent = totalVolume.toLocaleString();
            
            // Total TM (Truck No)
            const totalTM = new Set(filteredData.map(item => normalizeString(item['Truck No']))).size;
            document.getElementById('total-tm').textContent = totalTM;
            
            // Total Trip (DP No)
            const totalTrip = new Set(filteredData.map(item => item['DP No'])).size;
            
            // Avg Trip/TM
            const avgTripTM = totalTM > 0 ? totalTrip / totalTM : 0;
            document.getElementById('avg-trip-tm').textContent = avgTripTM.toFixed(2);
            
            // Avg Load/Trip
            const avgLoadTrip = totalTrip > 0 ? totalVolume / totalTrip : 0;
            document.getElementById('avg-load-trip').textContent = avgLoadTrip.toFixed(2);
        }
        
        // Update semua charts
        function updateCharts() {
            updateVolumePerAreaChart();
            updateVolumePerPlantChart();
            updateVolumePerDayAreaChart();
            updateVolumePerDayPlantChart();
            updateAvgVolumeDayAreaChart();
            updateAvgVolumeDayPlantChart();
            updateVolumePerTruckChart();
            updateTripPerTruckChart();
            updateAvgLoadTruckChart();
            updateAvgDistanceAreaChart();
            updateAvgDistancePlantChart();
            updateVolumeSalesmanChart();
            updateVolumeCustomerChart();
        }
        
        // Fungsi untuk mengelompokkan data dengan normalisasi
        function groupDataByNormalizedKey(data, key) {
            const grouped = {};
            
            data.forEach(item => {
                const value = item[key] || 'Unknown';
                const normalizedKey = normalizeString(value);
                
                if (!grouped[normalizedKey]) {
                    grouped[normalizedKey] = {
                        originalKey: value,
                        total: 0,
                        count: 0,
                        trips: new Set()
                    };
                }
                
                const volume = Number(item.QTY) || 0;
                grouped[normalizedKey].total += volume;
                grouped[normalizedKey].count += 1;
                
                // Untuk perhitungan trip (DP No)
                if (item['DP No']) {
                    grouped[normalizedKey].trips.add(item['DP No']);
                }
            });
            
            return grouped;
        }
        
        // Chart: Total Volume Delivery Per Area
        function updateVolumePerAreaChart() {
            const areaData = groupDataByNormalizedKey(filteredData, 'Area');
            
            const ctx = document.getElementById('volume-per-area-chart').getContext('2d');
            if (charts['volumePerArea']) {
                charts['volumePerArea'].destroy();
            }
            
            // Warna untuk chart
            const backgroundColors = [
                'rgba(54, 162, 235, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(255, 99, 132, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(201, 203, 207, 0.7)',
                'rgba(255, 205, 86, 0.7)',
                'rgba(100, 180, 135, 0.7)',
                'rgba(200, 100, 135, 0.7)',
                'rgba(150, 150, 235, 0.7)'
            ];
            
            charts['volumePerArea'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.values(areaData).map(item => item.originalKey),
                    datasets: [{
                        data: Object.values(areaData).map(item => item.total),
                        backgroundColor: backgroundColors,
                        borderColor: 'white',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Chart: Volume Per Day/Area (Line Chart)
        function updateVolumePerDayAreaChart() {
            // Kelompokkan data berdasarkan tanggal dan area
            const dateAreaData = {};
            
            filteredData.forEach(item => {
                const date = new Date(item['DP Date']).toLocaleDateString('id-ID');
                const area = item.Area || 'Unknown';
                const volume = Number(item.QTY) || 0;
                
                if (!dateAreaData[date]) {
                    dateAreaData[date] = {};
                }
                
                if (!dateAreaData[date][area]) {
                    dateAreaData[date][area] = 0;
                }
                
                dateAreaData[date][area] += volume;
            });
            
            // Ambil daftar area unik
            const areas = [...new Set(filteredData.map(item => item.Area).filter(a => a))];
            
            // Siapkan data untuk chart
            const dates = Object.keys(dateAreaData).sort();
            const datasets = areas.map(area => {
                return {
                    label: area,
                    data: dates.map(date => dateAreaData[date][area] || 0),
                    borderColor: `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 1)`,
                    backgroundColor: 'rgba(0, 0, 0, 0)',
                    tension: 0.3
                };
            });
            
            const ctx = document.getElementById('volume-per-day-area-chart').getContext('2d');
            if (charts['volumePerDayArea']) {
                charts['volumePerDayArea'].destroy();
            }
            
            charts['volumePerDayArea'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Chart: Volume Per Day/Plant (Line Chart)
        function updateVolumePerDayPlantChart() {
            // Kelompokkan data berdasarkan tanggal dan plant
            const datePlantData = {};
            
            filteredData.forEach(item => {
                const date = new Date(item['DP Date']).toLocaleDateString('id-ID');
                const plant = item['Plant Name'] || 'Unknown';
                const volume = Number(item.QTY) || 0;
                
                if (!datePlantData[date]) {
                    datePlantData[date] = {};
                }
                
                if (!datePlantData[date][plant]) {
                    datePlantData[date][plant] = 0;
                }
                
                datePlantData[date][plant] += volume;
            });
            
            // Ambil daftar plant unik (maksimal 5 untuk kejelasan)
            const plants = [...new Set(filteredData.map(item => item['Plant Name']).filter(p => p))].slice(0, 5);
            
            // Siapkan data untuk chart
            const dates = Object.keys(datePlantData).sort();
            const datasets = plants.map(plant => {
                return {
                    label: plant,
                    data: dates.map(date => datePlantData[date][plant] || 0),
                    borderColor: `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 1)`,
                    backgroundColor: 'rgba(0, 0, 0, 0)',
                    tension: 0.3
                };
            });
            
            const ctx = document.getElementById('volume-per-day-plant-chart').getContext('2d');
            if (charts['volumePerDayPlant']) {
                charts['volumePerDayPlant'].destroy();
            }
            
            charts['volumePerDayPlant'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Chart: Total Volume Delivery Per Plant Name
        function updateVolumePerPlantChart() {
            const plantData = groupDataByNormalizedKey(filteredData, 'Plant Name');
            
            // Ambil hanya 10 plant dengan volume tertinggi untuk kejelasan visual
            const sortedPlants = Object.values(plantData)
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);
            
            const ctx = document.getElementById('volume-per-plant-chart').getContext('2d');
            if (charts['volumePerPlant']) {
                charts['volumePerPlant'].destroy();
            }
            
            charts['volumePerPlant'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedPlants.map(item => item.originalKey),
                    datasets: [{
                        label: 'Total Volume',
                        data: sortedPlants.map(item => item.total),
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Chart: Avg Volume Delivery /Day per Area
        function updateAvgVolumeDayAreaChart() {
            const areaData = groupDataByNormalizedKey(filteredData, 'Area');
            
            // Hitung jumlah hari unik dalam data yang difilter
            const uniqueDays = new Set(filteredData.map(item => {
                const date = new Date(item['DP Date']);
                return date.toISOString().split('T')[0]; // Format YYYY-MM-DD
            })).size;
            
            const areaAvgPerDay = {};
            Object.keys(areaData).forEach(key => {
                areaAvgPerDay[key] = areaData[key].total / (uniqueDays > 0 ? uniqueDays : 1);
            });
            
            const ctx = document.getElementById('avg-volume-day-area-chart').getContext('2d');
            if (charts['avgVolumeDayArea']) {
                charts['avgVolumeDayArea'].destroy();
            }
            
            charts['avgVolumeDayArea'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.values(areaData).map(item => item.originalKey),
                    datasets: [{
                        label: 'Average Volume Per Day',
                        data: Object.values(areaData).map(item => item.total / (uniqueDays > 0 ? uniqueDays : 1)),
                        backgroundColor: 'rgba(255, 159, 64, 0.7)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Volume Per Day'
                            }
                        }
                    }
                }
            });
        }
        
        // Chart: Avg Volume Delivery /Day Per Plant
        function updateAvgVolumeDayPlantChart() {
            const plantData = groupDataByNormalizedKey(filteredData, 'Plant Name');
            
            // Hitung jumlah hari unik dalam data yang difilter
            const uniqueDays = new Set(filteredData.map(item => {
                const date = new Date(item['DP Date']);
                return date.toISOString().split('T')[0]; // Format YYYY-MM-DD
            })).size;
            
            // Ambil hanya 10 plant dengan volume tertinggi untuk kejelasan visual
            const sortedPlants = Object.values(plantData)
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);
            
            const ctx = document.getElementById('avg-volume-day-plant-chart').getContext('2d');
            if (charts['avgVolumeDayPlant']) {
                charts['avgVolumeDayPlant'].destroy();
            }
            
            charts['avgVolumeDayPlant'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedPlants.map(item => item.originalKey),
                    datasets: [{
                        label: 'Average Volume Per Day',
                        data: sortedPlants.map(item => item.total / (uniqueDays > 0 ? uniqueDays : 1)),
                        backgroundColor: 'rgba(153, 102, 255, 0.7)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Volume Per Day'
                            }
                        }
                    }
                }
            });
        }
        
        // Chart: Total Volume Delivery Per Truck No
        function updateVolumePerTruckChart() {
            const truckData = groupDataByNormalizedKey(filteredData, 'Truck No');
            
            // Ambil hanya 10 truck dengan volume tertinggi untuk kejelasan visual
            const sortedTrucks = Object.values(truckData)
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);
            
            const ctx = document.getElementById('volume-per-truck-chart').getContext('2d');
            if (charts['volumePerTruck']) {
                charts['volumePerTruck'].destroy();
            }
            
            charts['volumePerTruck'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedTrucks.map(item => item.originalKey),
                    datasets: [{
                        label: 'Total Volume',
                        data: sortedTrucks.map(item => item.total),
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Chart: Total Trip per Truck No
        function updateTripPerTruckChart() {
            const truckData = groupDataByNormalizedKey(filteredData, 'Truck No');
            
            const truckTripCounts = {};
            Object.keys(truckData).forEach(key => {
                truckTripCounts[key] = truckData[key].trips.size;
            });
            
            // Ambil hanya 10 truck dengan trip tertinggi untuk kejelasan visual
            const sortedTrucks = Object.entries(truckTripCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([key, value]) => ({
                    originalKey: truckData[key].originalKey,
                    tripCount: value
                }));
            
            const ctx = document.getElementById('trip-per-truck-chart').getContext('2d');
            if (charts['tripPerTruck']) {
                charts['tripPerTruck'].destroy();
            }
            
            charts['tripPerTruck'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedTrucks.map(item => item.originalKey),
                    datasets: [{
                        label: 'Total Trip',
                        data: sortedTrucks.map(item => item.tripCount),
                        backgroundColor: 'rgba(255, 205, 86, 0.7)',
                        borderColor: 'rgba(255, 205, 86, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Chart: Avg Load per Trip per Truck No
        function updateAvgLoadTruckChart() {
            const truckData = groupDataByNormalizedKey(filteredData, 'Truck No');
            
            const truckAvgLoad = {};
            Object.keys(truckData).forEach(key => {
                const tripCount = truckData[key].trips.size;
                truckAvgLoad[key] = tripCount > 0 ? truckData[key].total / tripCount : 0;
            });
            
            // Ambil hanya 10 truck dengan avg load tertinggi untuk kejelasan visual
            const sortedTrucks = Object.entries(truckAvgLoad)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([key, value]) => ({
                    originalKey: truckData[key].originalKey,
                    avgLoad: value
                }));
            
            const ctx = document.getElementById('avg-load-truck-chart').getContext('2d');
            if (charts['avgLoadTruck']) {
                charts['avgLoadTruck'].destroy();
            }
            
            charts['avgLoadTruck'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedTrucks.map(item => item.originalKey),
                    datasets: [{
                        label: 'Avg Load per Trip',
                        data: sortedTrucks.map(item => item.avgLoad),
                        backgroundColor: 'rgba(201, 203, 207, 0.7)',
                        borderColor: 'rgba(201, 203, 207, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Fungsi untuk mengelompokkan data dengan normalisasi dan menghitung jarak rata-rata
        function groupDataWithDistance(data, key) {
            const grouped = {};
            
            data.forEach(item => {
                const value = item[key] || 'Unknown';
                const normalizedKey = normalizeString(value);
                
                if (!grouped[normalizedKey]) {
                    grouped[normalizedKey] = {
                        originalKey: value,
                        totalDistance: 0,
                        count: 0
                    };
                }
                
                const distance = Number(item.Distance) || 0;
                grouped[normalizedKey].totalDistance += distance;
                grouped[normalizedKey].count += 1;
            });
            
            return grouped;
        }
        
        // Chart: Avg Distance Per Area
        function updateAvgDistanceAreaChart() {
            const areaData = groupDataWithDistance(filteredData, 'Area');
            
            const ctx = document.getElementById('avg-distance-area-chart').getContext('2d');
            if (charts['avgDistanceArea']) {
                charts['avgDistanceArea'].destroy();
            }
            
            charts['avgDistanceArea'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.values(areaData).map(item => item.originalKey),
                    datasets: [{
                        label: 'Average Distance',
                        data: Object.values(areaData).map(item => item.totalDistance / item.count),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Chart: Avg Distance Per Plant Name
        function updateAvgDistancePlantChart() {
            const plantData = groupDataWithDistance(filteredData, 'Plant Name');
            
            // Ambil hanya 10 plant dengan distance tertinggi untuk kejelasan visual
            const sortedPlants = Object.values(plantData)
                .sort((a, b) => (b.totalDistance / b.count) - (a.totalDistance / a.count))
                .slice(0, 10);
            
            const ctx = document.getElementById('avg-distance-plant-chart').getContext('2d');
            if (charts['avgDistancePlant']) {
                charts['avgDistancePlant'].destroy();
            }
            
            charts['avgDistancePlant'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedPlants.map(item => item.originalKey),
                    datasets: [{
                        label: 'Average Distance',
                        data: sortedPlants.map(item => item.totalDistance / item.count),
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Chart: Total Volume Per Sales Man
        function updateVolumeSalesmanChart() {
            const salesmanData = groupDataByNormalizedKey(filteredData, 'Sales Man');
            
            // Ambil hanya 10 salesman dengan volume tertinggi untuk kejelasan visual
            const sortedSalesmen = Object.values(salesmanData)
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);
            
            const ctx = document.getElementById('volume-salesman-chart').getContext('2d');
            if (charts['volumeSalesman']) {
                charts['volumeSalesman'].destroy();
            }
            
            charts['volumeSalesman'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedSalesmen.map(item => item.originalKey),
                    datasets: [{
                        label: 'Total Volume',
                        data: sortedSalesmen.map(item => item.total),
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Chart: Total Volume Per End Customer Name
        function updateVolumeCustomerChart() {
            const customerData = groupDataByNormalizedKey(filteredData, 'End Customer Name');
            
            // Ambil hanya 10 customer dengan volume tertinggi untuk kejelasan visual
            const sortedCustomers = Object.values(customerData)
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);
            
            const ctx = document.getElementById('volume-customer-chart').getContext('2d');
            if (charts['volumeCustomer']) {
                charts['volumeCustomer'].destroy();
            }
            
            charts['volumeCustomer'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedCustomers.map(item => item.originalKey),
                    datasets: [{
                        label: 'Total Volume',
                        data: sortedCustomers.map(item => item.total),
                        backgroundColor: 'rgba(153, 102, 255, 0.7)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
